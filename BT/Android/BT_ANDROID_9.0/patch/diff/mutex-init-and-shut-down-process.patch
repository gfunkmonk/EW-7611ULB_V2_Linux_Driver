From af17324f82861b0448ef975de020357eea579d41 Mon Sep 17 00:00:00 2001
From: cheng_cai <cheng_cai@realsil.com.cn>
Date: Mon, 3 Sep 2018 10:11:02 +0800
Subject: [PATCH] mutex init and shut down process

Change-Id: I4b6baf321cd900c0b61737b3c345a667f7b5a61d
---
 bluetooth/1.0/default/vendor_interface.cc | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/bluetooth/1.0/default/vendor_interface.cc b/bluetooth/1.0/default/vendor_interface.cc
index 1af8bf7..93925e4 100755
--- a/bluetooth/1.0/default/vendor_interface.cc
+++ b/bluetooth/1.0/default/vendor_interface.cc
@@ -52,6 +52,7 @@ bool recent_activity_flag;
 
 VendorInterface* g_vendor_interface = nullptr;
 std::mutex wakeup_mutex_;
+std::mutex init_mutex_;
 
 HC_BT_HDR* WrapPacketAndCopy(uint16_t event, const hidl_vec<uint8_t>& data) {
   size_t packet_size = data.size() + sizeof(HC_BT_HDR);
@@ -165,6 +166,7 @@ bool VendorInterface::Initialize(
     InitializeCompleteCallback initialize_complete_cb,
     PacketReadCallback event_cb, PacketReadCallback acl_cb,
     PacketReadCallback sco_cb) {
+  std::unique_lock<std::mutex> lock(init_mutex_);
   if (g_vendor_interface) {
     ALOGE("%s: No previous Shutdown()?", __func__);
     return false;
@@ -175,6 +177,7 @@ bool VendorInterface::Initialize(
 }
 
 void VendorInterface::Shutdown() {
+  std::unique_lock<std::mutex> lock(init_mutex_);
   LOG_ALWAYS_FATAL_IF(!g_vendor_interface, "%s: No Vendor interface!",
                       __func__);
   g_vendor_interface->Close();
-- 
1.9.1

