From cbba9e3b8c3244bcbbbb1d7fa13b03f971e3a7bc Mon Sep 17 00:00:00 2001
From: ranhui_xia <ranhui_xia@realsil.com.cn>
Date: Thu, 12 Dec 2013 11:39:13 +0800
Subject: [PATCH 07/13] Realtek BT: Fix pairing hid hang bug when connect le
 hid fail

We should notify upper to update status

Signed-off-by: ranhui_xia <ranhui_xia@realsil.com.cn>
---
 stack/btm/btm_sec.c | 23 +++++++++++++++++++++++
 1 file changed, 23 insertions(+)

diff --git a/stack/btm/btm_sec.c b/stack/btm/btm_sec.c
index 8bcf435..f340ef2 100644
--- a/stack/btm/btm_sec.c
+++ b/stack/btm/btm_sec.c
@@ -4245,6 +4245,29 @@ void btm_sec_connected (UINT8 *bda, UINT16 handle, UINT8 status, UINT8 enc_mode)
             }
         }
 
+        //REALTEK ADD START
+        if (status == HCI_ERR_CONNECTION_TOUT || status == HCI_ERR_LMP_RESPONSE_TIMEOUT  ||
+            status == HCI_ERR_UNSPECIFIED     || status == HCI_ERR_PAGE_TIMEOUT)
+        {
+            BTM_TRACE_ERROR1("sec_flags:%x ", p_dev_rec->sec_flags);
+            if(!(p_dev_rec->sec_flags &0x10))
+            {
+                UINT32 devClass = 0;
+                devClass = devclass2uint(p_dev_rec->dev_class);
+                BTM_TRACE_ERROR1("devClass :%x ", devClass );
+                if ((devClass & 0x7ff) == 0x0580){
+                    BTM_TRACE_ERROR0("HID Pointing device, BT_BOND_STATE_NONE");
+                    /* We need to notify host that the key is not known any more */
+                    if (btm_cb.api.p_auth_complete_callback)
+                    {
+                        (*btm_cb.api.p_auth_complete_callback) (p_dev_rec->bd_addr,
+                                                                p_dev_rec->dev_class,
+                                                                p_dev_rec->sec_bd_name, status);
+                    }
+                }
+           }
+        }
+        //REALTEK ADD END
         if (status == HCI_ERR_CONNECTION_TOUT || status == HCI_ERR_LMP_RESPONSE_TIMEOUT  ||
             status == HCI_ERR_UNSPECIFIED     || status == HCI_ERR_PAGE_TIMEOUT)
             btm_sec_dev_rec_cback_event (p_dev_rec, BTM_DEVICE_TIMEOUT);
-- 
1.8.5.rc2

