From 59e3d6c34308eee576d2ffc19337f6378c601d65 Mon Sep 17 00:00:00 2001
From: ranhui_xia <ranhui_xia@realsil.com.cn>
Date: Thu, 12 Dec 2013 10:57:01 +0800
Subject: [PATCH 05/13] Realtek BT: Fix inquiry too long

Add rssi threshold to filter bt devices

Signed-off-by: ranhui_xia <ranhui_xia@realsil.com.cn>
---
 bta/dm/bta_dm_act.c | 28 +++++++++++++++++++++++-----
 1 file changed, 23 insertions(+), 5 deletions(-)

diff --git a/bta/dm/bta_dm_act.c b/bta/dm/bta_dm_act.c
index 40cfb9e..73be545 100644
--- a/bta/dm/bta_dm_act.c
+++ b/bta/dm/bta_dm_act.c
@@ -233,6 +233,9 @@ const tBTA_DM_LMP_VER_INFO bta_role_switch_blacklist[BTA_DM_MAX_ROLE_SWITCH_BLAC
 #define MAX_DISC_RAW_DATA_BUF       (4096)
 UINT8 g_disc_raw_data_buf[MAX_DISC_RAW_DATA_BUF];
 
+//RTK add start
+INT8 gRssiThresholdForRemoteName = -70;
+//RTK add end
 /*******************************************************************************
 **
 ** Function         bta_dm_app_ready_timer_cback
@@ -2374,16 +2377,31 @@ static void bta_dm_discover_device(BD_ADDR remote_bd_addr)
     if ((!bta_dm_search_cb.name_discover_done)
        && (( bta_dm_search_cb.p_btm_inq_info == NULL )
             ||(bta_dm_search_cb.p_btm_inq_info && (!bta_dm_search_cb.p_btm_inq_info->appl_knows_rem_name))))
-    {
-        if( bta_dm_read_remote_device_name(bta_dm_search_cb.peer_bdaddr) == TRUE )
+	 {
+        //RTK add start
+	    if(bta_dm_search_cb.p_btm_inq_info != NULL)
         {
-            return;
+            APPL_TRACE_DEBUG1("RSSI: %d", bta_dm_search_cb.p_btm_inq_info->results.rssi);
         }
-        else
+        if(bta_dm_search_cb.p_btm_inq_info != NULL&&bta_dm_search_cb.p_btm_inq_info->results.rssi < gRssiThresholdForRemoteName)
         {
-            /* starting name discovery failed */
+            /* not req remote name */
+            APPL_TRACE_DEBUG0("RSSI is too low, device is far away, not ask remote name");
             bta_dm_search_cb.name_discover_done = TRUE;
         }
+        else
+        {
+            if( bta_dm_read_remote_device_name(bta_dm_search_cb.peer_bdaddr) == TRUE )
+            {
+                return;
+            }
+            else
+            {
+                /* starting name discovery failed */
+                bta_dm_search_cb.name_discover_done = TRUE;
+            }
+        }
+       //RTK add end
     }
 
     /* if application wants to discover service */
-- 
1.8.5.rc2

