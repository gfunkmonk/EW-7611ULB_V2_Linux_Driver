#!/bin/bash

# Script to run wpa_supplicant for wlan0

set -e

# Check if wireless tools exist
if ! command -v iwconfig &> /dev/null; then 
    echo "ERROR: Wireless tools not found!"
    echo "Please install wireless-tools package"
    exit 1
fi

# Determine the appropriate driver
# For kernel 2.4.x, use ipw driver
# For newer kernels with wireless-tools < v18, use ipw driver
# Otherwise, use wext driver
KERNEL_MAJOR=$(uname -r | cut -d. -f1)
KERNEL_MINOR=$(uname -r | cut -d. -f2)

if [ "$KERNEL_MAJOR" -eq 2 ] && [ "$KERNEL_MINOR" -eq 4 ]; then
    DRIVER="ipw"
else
    IWCONFIG_VERSION=$(iwconfig -v 2>&1 | awk '{print $4}' | head -n 1)
    if [ -n "$IWCONFIG_VERSION" ] && [ "$IWCONFIG_VERSION" -lt 18 ]; then
        DRIVER="ipw"
    else
        DRIVER="wext"
    fi
fi

echo "Starting wpa_supplicant with driver: $DRIVER"
wpa_supplicant -D "$DRIVER" -c wpa1.conf -i wlan0
